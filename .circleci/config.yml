version: 2.1

executors:
  collector-ci-image:
    docker:
      - image: docker.io/stackrox/apollo-ci:collector-0.1.11-18-g3ecb0861c9
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    environment:
      ROX_CI_IMAGE: "true"

commands:
  init:
    steps:
    - attach_workspace:
        at: ~/workspace
    - run:
        name: Set up environment
        command: |
          # Set the workspace root, and also make sure that the `shared-env` file is sourced in every step.
          cat >>"$BASH_ENV" \<<-"EOF"
          	export WORKSPACE_ROOT="${HOME}/workspace"
            [[ -f "${WORKSPACE_ROOT}/shared-env" ]] && source "${WORKSPACE_ROOT}/shared-env"
          EOF

  gcloud-init:
    steps:
    - run:
        name: Install and configure gcloud
        working_directory: ~/.config/gcloud
        command: |
          if [[ "$ROX_CI_IMAGE" != "true" ]]; then
            pip install -U crcmod google_compute_engine
          fi
          gcloud auth activate-service-account --key-file <(echo "$GOOGLE_CREDENTIALS_KERNEL_CACHE")
          gcloud auth list

  docker-login:
    steps:
    - run:
        name: Login to Docker Hub
        command: docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"

jobs:
  init:
    docker:
    - image: circleci/golang:1.11.2-stretch
    working_directory: ~/workspace

    steps:
    - checkout:
        path: ~/workspace/go/src/github.com/stackrox/collector

    - run:
        name: Set up shared environment
        command: |
          cat >~/workspace/shared-env \<<-"EOF"
          	export GOPATH="${WORKSPACE_ROOT}/go"
          	export SOURCE_ROOT="${GOPATH}/src/github.com/stackrox/collector"
            export COLLECTOR_SOURCE_ROOT="${SOURCE_ROOT}/collector"
          	export PATH="${PATH}:${GOPATH}/bin:${WORKSPACE_ROOT}/bin"
          EOF

          COLLECTOR_VERSION="$(make -s -C ~/workspace/go/src/github.com/stackrox/collector/collector tag)"
          cat >>~/workspace/shared-env \<<-EOF
          	export COLLECTOR_VERSION="$COLLECTOR_VERSION"
          EOF

    - persist_to_workspace:
        root: ~/workspace
        paths:
        - go/src/github.com/stackrox/collector
        - shared-env

  builder:
    machine: true
    steps:
    - init
    - docker-login

    - run:
        name: Restore collector-builder cache image
        command: docker pull stackrox/collector-builder:cache || true

    - run:
        name: Build collector builder Docker image
        command: |
          docker build \
            --cache-from stackrox/collector-builder:cache \
            -t stackrox/collector-builder:cache "${SOURCE_ROOT}/builder"

    - run:
        name: Save collector-builder cache image
        command: |
          docker push stackrox/collector-builder:cache
          docker tag stackrox/collector-builder:cache "stackrox/collector-builder:circle-build-${CIRCLE_WORKFLOW_ID}"
          docker push "stackrox/collector-builder:circle-build-${CIRCLE_WORKFLOW_ID}"

  prepare-kernels:
    executor: collector-ci-container
    working_directory: ~/workspace

    steps:
    - init

    - run:
        name: Compile kobuild
        command: |
          mkdir bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -a -o ./bin/kobuild \
            github.com/stackrox/collector/kernel-modules/build/kobuild

    - run:
        name: Prepare source
        command: |
          mkdir -p /tmp/ko-build/versions-src
          SYSDIG_DIR="${SOURCE_ROOT}/sysdig/src" \
              SCRATCH_DIR=/tmp/ko-build/scratch \
              OUTPUT_DIR=/tmp/ko-build/versions-src \
            "${SOURCE_ROOT}/kernel-modules/build/prepare-src"

          source_archives=(/tmp/ko-build/versions-src/*)
          [[ "${#source_archives[@]}" == 1 ]] || {
            echo "Expected a single kernel module source version, got:"
            printf '- %s\n' "${source_archives[@]}"
            exit 1
          } >&2

          version="$(basename "${source_archives[0]}" '.tgz')"
          cat >>"${WORKSPACE_ROOT}/shared-env" \<<-EOF
          	export MODULE_VERSION=$(printf '%q' "$version")
          EOF

    - run:
        name: Prepare Kernel module build cache lookup
        command: |
          # Since we cannot have $MODULE_VERSION as part of the cache key directly, we need to write it to a file
          # that is then checksummed.
          echo "$MODULE_VERSION" >/tmp/kernel-modules-cache-version.txt

    - restore_cache:
        name: Restore Kernel module build cache
        keys:
          - kernel-module-cache-v2-{{ checksum "/tmp/kernel-modules-cache-version.txt" }}-{{ .Branch }}-{{ .Revision }}
          - kernel-module-cache-v2-{{ checksum "/tmp/kernel-modules-cache-version.txt" }}-{{ .Branch }}-
          - kernel-module-cache-v2-{{ checksum "/tmp/kernel-modules-cache-version.txt" }}-master-
          - kernel-module-cache-v2-{{ checksum "/tmp/kernel-modules-cache-version.txt" }}-

    - run:
        name: Copy cached modules to build output
        command: |
          mkdir -p "${WORKSPACE_ROOT}/ko-build/build-output/${MODULE_VERSION}"
          CACHE_DIR="/tmp/cache/kernel-modules/${MODULE_VERSION}/"
          [[ -d "$CACHE_DIR" ]] || exit 0
          mv -v \
              "$CACHE_DIR"/* \
              "${WORKSPACE_ROOT}/ko-build/build-output/${MODULE_VERSION}/" \
            || true

    - run:
        name: Extract module source
        command: |
          mkdir -p "${WORKSPACE_ROOT}/ko-build"
          cd "${WORKSPACE_ROOT}/ko-build"

          mkdir -p "module-versions/${MODULE_VERSION}"
          tar -C "module-versions/${MODULE_VERSION}" -xvzf "/tmp/ko-build/versions-src/${MODULE_VERSION}.tgz"

    - run:
        name: Compile list of existing modules
        command: |
          ( ls "${WORKSPACE_ROOT}/ko-build/build-output/${MODULE_VERSION}"/*.ko{,.gz} || true ) \
            | sed -ne 's@^.*/collector-\([^/]\{1,\}\)\.ko\(\.gz\)\{0,1\}$@\1@p' \
              >/tmp/ko-build/existing-modules-"${MODULE_VERSION}"

    - run:
        name: Generate list of all (source, kernel version) build combinations
        command: |
          cd "${WORKSPACE_ROOT}"
          ./bin/kobuild \
              --config "${SOURCE_ROOT}/kernel-modules/supported-kernels/kernel-manifest.yml" \
              --kernel-versions-file /tmp/ko-build/existing-modules-"${version}" \
              --exclude \
              --output "{{.KernelVersion}} ${version}"
            | sort | uniq >ko-build/build-tasks-current

    - persist_to_workspace:
        root: ~/workspace
        paths:
          - ko-build
          - bin
          - shared-env

  prepare-kernels-legacy:
    executor: collector-ci-container

    working_directory: ~/workspace

    steps:
    - init
    - gcloud-init

    - checkout:
        at: ~/workspace/go/src/github.com/stackrox/collector

    - run:
        name: Check if we need to rebuild any other modules
        command: |
          if git diff --quiet HEAD^ -- "${SOURCE_ROOT}/kernel-modules/supported-kernels/kernel-manifest.yml"; then
            echo "Detected change in kernel manifest file."
            exit 0
          elif git diff --quiet HEAD^ -- "${SOURCE_ROOT}/released-versions/list/"; then
            echo "Detected change in released version list."
            exit 0
          fi
          echo "No relevant changes detected."
          circleci step halt

    - run:
        name: Building kernel module source archives for released versions
        command: |
          cd "${SOURCE_ROOT}"
          IFS=$'\n' read -d'' -r -a released_version_files < <(
            find 'released-versions/list' -name '.version' -printf '%P\n')

          for version_file in "${released_version_files[@]}"; do
            release_version="$(dirname "$version_file")"
            git checkout "$release_version"

            echo " - ${release_version}"
            SYSDIG_DIR="${PWD}/sysdig/src" \
                SCRATCH_DIR=/tmp/scratch \
                OUTPUT_DIR=/tmp/ko-build-legacy/versions-src \
              ./kernel-modules/build/prepare-src"
          done

    - run:
        name: Preparing module build
        command: |
          cd "${WORKSPACE_ROOT}/ko-build"

          echo >publish-list
          if rm -fv "/tmp/ko-build/legacy-versions-src/${MODULE_VERSION}.tgz"; then
            echo "current/${MODULE_VERSION}" >>publish-list
          fi

          for archive in "/tmp/ko-build/legacy-versions-src"/*.tgz; then
            version="$(basename "$archive" '.tgz')"
            mkdir -p "module-versions/${version}"
            tar -C "module-versions/${version}" -xvzf "$archive"
            echo "legacy/${version}" >>publish-list
          fi

    - persist_to_workspace:
        root: ~/workspace
        paths:
          - ko-build/publish-list
          - ko-build/legacy

  kernels:
    parameters:
      type:
        description: "Build current or legacy kernel modules?"
        default: current
        type: string
      parallelism:
        description: "How many concurrent builds to run"
        type: integer
        default: 8

    machine: true
    parallelism: << parameters.parallelism >>
    environment:
    - BUILD_CONTAINER_TAG: stackrox/collector-builder:kobuilder-cache
    - BUILD_CONTAINER_CACHE_IMAGES: stackrox/collector-builder:kobuilder-cache

    steps:
    - init

    - run:
        name: Determine tasks for current shard
        command: |
          cd "${WORKSPACE_ROOT}/ko-build"

          echo "Nodes total: $CIRCLE_NODE_TOTAL"
          echo "Node index:  $CIRCLE_NODE_INDEX"

          task_file=

          num_tasks=$(wc -l <build-tasks)
          shard_size=$(((num_tasks - 1) / CIRCLE_NODE_TOTAL + 1))

          echo "Total number of tasks: ${num_tasks}"
          echo "Tasks per shard: ${shard_size}"

          mkdir -p /tmp/ko-build
          split -d -l "$shard_size" build-tasks /tmp/ko-build/task-shard-

          this_shard_file=/tmp/ko-build/task-shard-"$(printf '%02d' "$CIRCLE_NODE_INDEX")"
          if [[ ! -s "$this_shard_file" ]]; then
            echo "Nothing to be done for this shard."
            circleci step halt
            exit 0
          fi

          # Create build-output directories for modules, and write all kernel versions to
          # /tmp/ko-build/kernel-versions-<modver>
          while read -a line || [[ "${#line[@]}" > 0 ]]; do
            kernel_version="${line[0]}"
            module_version="${line[1]}"

            mkdir -p "build-output/${module_version}"
            echo "$kernel_version" >>/tmp/ko-build/kernel-versions-"${module_version}"
          done <"$this_shard_file"

          # Write all build commands to /tmp/ko-build/all-build-commands
          echo >/tmp/ko-build/all-build-commands
          for i in build-output/*/; do
            module_version="$(basename "$i")"
            kobuild \
                --config "${SOURCE_ROOT}/kernel-modules/supported-kernels/kernel-manifest.yml" \
                --kernel-versions-file "/tmp/ko-build/kernel-versions-${module_version}" \
                --output 'SOURCE_VERSION='"$(printf '%q' "$module_version")"' {{.BuildCommand "build-kos"}}' \
                \>> /tmp/ko-build/all-build-commands
          done

    - gcloud-init
    - run:
        name: Download required packages
        command: |
          cat /tmp/ko-build/kernel-versions-* | sort | uniq >/tmp/ko-build/all-kernel-versions
          kobuild \
              --config "${SOURCE_ROOT}/kernel-modules/supported-kernels/kernel-manifest.yml" \
              --kernel-versions-file /tmp/ko-build/all-kernel-versions \
              --output '{{.PackageListURLEncoded}}' \
            | sort | uniq \
            | sed -e 's@^@gs://stackrox-kernel-headers-mirror/packages/@' \
              >~/kobuild-tmp/all-package-objects
          cat ~/kobuild-tmp/all-package-objects

          cat ~/kobuild-tmp/all-package-objects

          mkdir -p ~/kobuild-tmp/packages
          gsutil -m cp -I ~/kobuild-tmp/packages/ <~/kobuild-tmp/all-package-objects

    - docker-login

    - run:
        name: Restore builder cache image(s)
        command: docker pull $BUILD_CONTAINER_CACHE_IMAGES || true

    - run:
        name: Build builder image
        command: |
          make -C "${SOURCE_ROOT}/kernel-modules" build-container
          docker tag "$BUILD_CONTAINER_TAG" build-kernel-modules

    - run:
        name: Upload builder cache image
        command: |
          [[ "$CIRCLE_BRANCH" == "master" ]] || exit 0
          (( CIRCLE_NODE_INDEX == 0 )) || exit 0
          docker push "$BUILD_CONTAINER_TAG"
        background: true

    - run:
        name: Build modules
        command: |
          docker run --rm -i \
            -v "${HOME}/kobuild-tmp/packages:/packages:ro" \
            -v "${WORKSPACE_ROOT}/ko-build/<< parameters.subdir >>/module-versions:/sources:ro" \
            -v "${WORKSPACE_ROOT}/ko-build/build-output:/output" \
            --tmpfs /scratch:exec \
            build-kernel-modules \
            sh - <~/kobuild-tmp/all-build-commands

    - persist_to_workspace:
        root: ~/workspace
        paths:
          - ko-build/build-output
  grpc:
    docker:
    - image: ubuntu:trusty
    working_directory: /go/src/github.com/stackrox/collector

    steps:
    - checkout

    - run:
        name: Install dependencies
        command: |
          apt-get update -y
          apt-get install -y build-essential ca-certificates

    - restore_cache:
        key: grpc-cpp-plugin-v1-{{ checksum "build/scripts/install-grpc-cpp-plugin.sh" }}

    - run:
        name: Build grpc plugin
        command: |
          if [[ ! -x /usr/local/bin/grpc_cpp_plugin ]]; then
            make -C collector install-grpc
          fi

    - save_cache:
        key: grpc-cpp-plugin-v1-{{ checksum "build/scripts/install-grpc-cpp-plugin.sh" }}
        paths:
          - /usr/local/bin/grpc_cpp_plugin

    - persist_to_workspace:
        root: /usr/local
        paths:
          - bin/grpc_cpp_plugin

  libsinsp:
    machine: true
    working_directory: ~/workspace

    steps:
    - init
    - docker-login

    - run:
        name: Restore sysdig builder cache image
        command: docker pull stackrox/collector-builder:sysdig || true

    - run:
        name: Build libsinsp Wrapper
        command: make -C "${COLLECTOR_SOURCE_ROOT}" container/libs/libsinsp-wrapper.so

    - run:
        name: Sanity check
        command: |
          cd "${COLLECTOR_SOURCE_ROOT}"
          ls -lh container/libs
          file   container/libs/libsinsp-wrapper.so
          docker images | grep collector

    - run:
        name: Save sysdig builder cache image
        command: docker push stackrox/collector-builder:sysdig

    - persist_to_workspace:
        root: ~/workspace
        paths:
        - go/src/github.com/stackrox/collector/collector/container/libs

  collector:
    machine: true
    working_directory: ~/workspace

    steps:
    - init
    - docker-login

    - run:
        name: Restore collector-builder image created in this run.
        command: docker pull "stackrox/collector-builder:circle-build-${CIRCLE_WORKFLOW_ID}"

    - run:
        name: Sanity Check
        command: |
          cd "${SOURCE_ROOT}"
          pwd
          echo '>>> Userspace lib:'
          ls -lh collector/container/libs
          file   collector/container/libs/libsinsp-wrapper.so
          echo '>>> Docker images:'
          docker images | grep collector
          echo '>>> gRPC plugin:'
          which grpc_cpp_plugin

    - run:
        name: Generate Protobuf Definitions
        command: make -C "$COLLECTOR_SOURCE_ROOT" generated-srcs

    - run:
        name: Build collector
        command: |
          cd "$COLLECTOR_SOURCE_ROOT"
          mkdir -p container/bin
          docker run \
            -v "$PWD:/src:ro" \
            -v "$PWD/sysdig/src:/usr/local/sysdig:ro" \
            -v "$PWD/container/libs/libsinsp-wrapper.so:/usr/local/lib/libsinsp-wrapper.so:ro" \
            -v "$PWD/sysdig/src/driver/ppm_events_public.h:/usr/local/include/ppm_events_public.h:ro" \
            -v "$PWD/cmake-build:/build-output" \
            --name build "stackrox/collector-builder:circle-build-${CIRCLE_WORKFLOW_ID}"

    - run:
        name: Extract collector files
        command: |
          cd "$COLLECTOR_SOURCE_ROOT"
          cp -v cmake-build/collector container/bin/
          ls -lh container/bin/

    - persist_to_workspace:
        root: ~/workspace
        paths:
        - go/src/github.com/stackrox/collector/collector/container/bin

  images:
    machine: true

    steps:
    - init
    - docker-login

    - run:
        name: Copying Kernel modules build output
        command: |
          mkdir -p "${SOURCE_ROOT}/kernel-modules/container/kernel-modules"
          mv "${WORKSPACE_ROOT}/ko-build/build-output/${MODULE_VERSION}"/* \
            "${SOURCE_ROOT}/kernel-modules/container/kernel-modules" || true

    - run:
        name: Preparing Kernel modules build cache
        command: |
          mkdir -p "/tmp/cache/kernel-modules/${MODULE_VERSION}/"
          cp -rlv "${SOURCE_ROOT}/kernel-modules/container/kernel-modules/." \
            "/tmp/cache/kernel-modules/${MODULE_VERSION}/"

          # This file won't be cached, but we need it to make the actual module version (via checksum) become
          # part of the cache key.
          echo "$MODULE_VERSION" >/tmp/kernel-modules-cache-version.txt

    - save_cache:
        name: Saving Kernel module build cache
        key: kernel-module-cache-v2-{{ checksum "/tmp/kernel-modules-cache-version.txt" }}-{{ .Branch }}-{{ .Revision }}
        paths:
          - /tmp/cache/

    - run:
        name: Adding Kernel module version file
        command: |
          mkdir -p "${SOURCE_ROOT}/kernel-modules/container/kernel-modules"
          echo "$MODULE_VERSION" \
            >"${SOURCE_ROOT}/kernel-modules/container/kernel-modules/MODULE_VERSION.txt"

    - run:
        name: Sanity check
        command: |
          cd "$SOURCE_ROOT"
          echo '>>> Collector Artifacts:'
          find collector/container
          echo '>>> Kernel Modules:'
          find kernel-modules/container

    - run:
        name: Build kernel-modules Docker image
        command: |
          cd "${SOURCE_ROOT}/kernel-modules/container"
          docker build \
            -t "stackrox/kernel-modules:${MODULE_VERSION}" \
            -t "stackrox/kernel-modules:snapshot-${COLLECTOR_VERSION}" \
            .

    - run:
        name: Build collector Docker image
        command: |
          cd "$COLLECTOR_SOURCE_ROOT"
          cp NOTICE-collector.txt container/
          cp COPYING.txt container/
          docker build \
            -t "stackrox/collector:snapshot-${COLLECTOR_VERSION}" \
            -t "stackrox/collector:${COLLECTOR_VERSION}" \
            --build-arg base="$MODULE_VERSION" \
            container

    - run:
        name: Sanity check images
        command: |
          docker images | grep kernel | grep "$MODULE_VERSION"
          docker images | grep collector | grep "$COLLECTOR_VERSION"

    - run:
        name: Push images
        command: |
          if [[ $CIRCLE_BRANCH = master || -n $CIRCLE_TAG ]]; then
            echo Pushing release images
            docker push "stackrox/collector:${COLLECTOR_VERSION}"
            echo "Pushing kernel modules"
            docker push "stackrox/kernel-modules:${MODULE_VERSION}"
          else
            echo Pushing snapshot images
            docker push "stackrox/collector:snapshot-${COLLECTOR_VERSION}"

            # For the snapshot image, use the *collector* version, not the module version.
            echo "Pushing kernel modules"
            docker push "stackrox/kernel-modules:snapshot-${COLLECTOR_VERSION}"
          fi

    - run:
        name: Integration tests
        command: |
          cd "$COLLECTOR_SOURCE_ROOT"
          go get -u github.com/jstemmer/go-junit-report
          curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
          sudo mv /tmp/dep /usr/local/bin/dep
          export COLLECTOR_TAG="$COLLECTOR_VERSION"
          sudo curl -L "https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          make integration-tests integration-test-report


  push-release-info:
    docker:
    - image: circleci/golang:1.11.2-stretch

    steps:
    - run:
        name: Sanity check
        command: |
          [[ -n "$CIRCLE_TAG" ]] || {
            echo '$CIRCLE_TAG is not set -- this job should not be run!'
            exit 1
          } >&2

    - init

    # Re-checkout - the code is already in the workspace, but this is necessary to set up SSH keys for github.
    - checkout:
        path: ~/workspace/go/src/github.com/stackrox/collector

    # Add the SSH key which will allow pushing to the repo.
    - add_ssh_keys:
        fingerprints:
          - "df:30:53:b4:a5:91:49:a8:48:ec:d8:3d:b0:95:8a:db"

    - run:
        name: Mark version as released
        command: |
          cd "${SOURCE_ROOT}"
          git checkout master && git pull
          git config user.email 'mi+robotrox@stackrox.com'
          git config user.name 'Robot Rox'
          git checkout -b test-master || git checkout test-master

          version_dir="released-versions/list/${CIRCLE_TAG}"
          mkdir -p "$version_dir"
          touch "${version_dir}/.version"
          echo "$MODULE_VERSION" >"${version_dir}/collector-module-version"
          git add -r "${version_dir}/.version" "${version_dir}"
          git commit -m "Marking version ${CIRCLE_TAG} as released."
          git push -u origin test-master

  publish-modules:
    executor: collector-ci-container

    steps:
    - run:
        name: Sanity check
        command: |
          [[ -n "$PUBLISHED_MODULES_BUCKET" ]] || {
            echo '$PUBLISHED_MODULES_BUCKET not set -- cannot publish collector modules!'
            exit 1
          } >&2

    - init
    - gcloud-init

    - run:
        name: Prepare synchronization state
        command: |
          mkdir -p /tmp/publish-modules

          cd "${WORKSPACE_ROOT}/ko-build"
          while read -r version; do
            if [[ -d "build-output/${version}" ]]; then
              echo >&2 "Version ${version} not found in build output."
            fi
            cp -rlv "build-output/${version}" /tmp/publish-modules/
          done <./publish-list

    - run:
        name: Upload modules to GCS bucket
        command: |
          gsutil -m rsync -r /tmp/publish-modules "$PUBLISHED_MODULES_BUCKET"

workflows:
  version: 2
  build:
    jobs:
    - init:
        filters:
          tags:
            only: /.*/
    - builder:
        requires:
        - init
        filters:
          tags:
            only: /.*/
    - grpc:
        filters:
          tags:
            only: /.*/
    - libsinsp:
        requires:
        - init
        filters:
          tags:
            only: /.*/
    - collector:
        requires:
        - builder
        - grpc
        - libsinsp
        filters:
          tags:
            only: /.*/
    - prepare-kernels:
        requires:
        - init
        filters:
          tags:
            only: /.*/
    - prepare-kernels-legacy:
        requires:
          - prepare-kernels
        filters:
          branches:
            only: master
    - kernels:
        requires:
          - prepare-kernels
        filters:
          tags:
            only: /.*/
    - kernels:
        name: kernels-legacy
        legacy: true
        requires:
          - prepare-kernels-legacy
        filters:
          branches:
            only: master
    - images:
        requires:
        - collector
        - kernels
        filters:
          tags:
            only: /.*/
    - push-release-info:
        requires:
          - images
        filters:
          tags:
            only: /.*/
          branches:
            ignore: /.*/
    - publish-modules:
        requires:
          - kernels
          - kernels-legacy
        filters:
          branches:
            only: master
