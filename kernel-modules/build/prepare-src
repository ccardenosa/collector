#!/usr/bin/env bash

set -eo pipefail

mkdir -p /scratch/sysdig-src
mkdir -p /scratch/cmake-build

cp -r /sysdig-src/. /scratch/sysdig-src
cd /scratch/cmake-build

modfiles0() (
	local dir="${1:-/scratch/sysdig-src/driver}"
    cd "$dir"
    find . -type f \( -name 'Makefile' -o -name '*.c' -o -name '*.h' \) -print0 | \
    	sort -z
)

get_module_version() (
	modfiles0 "$@" | \
		xargs -0 sha256sum | \
		awk '{print$1 " " $2}' | \
		sha256sum | \
		awk '{print$1}'
)

cmake \
	-DCMAKE_BUILD_TYPE=Release \
	-DCMAKE_C_FLAGS="-fno-pie" \
	-DPROBE_NAME=collector \
	-DBUILD_USERSPACE=OFF \
	-DENABLE_DKMS=OFF \
	/scratch/sysdig-src
KERNELDIR=/dev/null make driver/fast || true

cd /scratch/sysdig-src/driver
module_version="$(get_module_version .)"

source_archive="/output/${module_version}.tgz"
if [[ -s "$source_archive" ]]; then
	exit 0
fi
modfiles0 . | xargs -0 tar cfvz "$source_archive"
